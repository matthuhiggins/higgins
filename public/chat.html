<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
<head>
  <title>Chat</title>
  <style>
    #messages {
      height: 200px;
      overflow-y: scroll;
      width: 500px;
    }
  </style>
</head>
<body>
  <h2>Welcome to Chat</h2>
  <div id="messages">
  </div>

  <form id="message-form">
    <input id="message" type="text" />
  </form>
  
  <script>
  function addMessage(message) {
    var messageBox = document.getElementById('messages');
    messageBox.innerHTML += "<div>" + message + "</div>";
    messageBox.scrollTop = messageBox.scrollHeight;
  }
  
  (function() {
    var messageInput = document.getElementById('message');
    document.getElementById('message-form').onsubmit = function() {
      var message = messageInput.value,
          request = new XMLHttpRequest();
      request.open('POST', "/message", true);
      request.send(message);
      messageInput.value = "";
      return false;
    };
    messageInput.focus();
  })();
  
  (function() {
    var currentRevision = null;

    function messagePath() {
      if (currentRevision == null) {
        return "/message";
      } else {
        return "/message/" + currentRevision;
      }
    }
    
    var loadMessages = function(messages) {
      for(var i = 0; i < messages.length; i++) {
        addMessage(messages[i]);
      }
    };
    
    var retrieve = function() {
      var request = new XMLHttpRequest();

      request.open('GET', messagePath(), true);
      var requestPoll = setTimeout(function() {
        if (request.readyState == 4) {
          window.clearTimeout(requestPoll);
          var result = eval("(" + request.responseText + ")");
          currentRevision = result.number;
          loadMessages(result.messages);
        }
      }, 50);
      request.send(null);
    };
    
    retrieve();
    setInterval(retrieve, 1000);
  })();
  </script>
</body>
</html>